{% extends 'components/base.html' %}
{% load static %}

    {% block styles %}
	<style>
		.img{
			width:30px;
		}
	</style>
    {% endblock %}
    
        {% block content %}
        
							<!-- PAGE-HEADER -->
							<div class="page-header">
								<div>
									<h1 class="page-title">Carburant</h1>
								</div>
								<div class="ms-auto pageheader-btn">
									<ol class="breadcrumb">
                                        {% comment %} <li class="breadcrumb-item">Logistiques</li> {% endcomment %}
                                        <li class="breadcrumb-item"><a href="logistiques">Logistiques</a></li>
                                        <li class="breadcrumb-item active" aria-current="page">Carburant</li>
                                    </ol>
								</div>
							</div>
							<!-- PAGE-HEADER END -->

							<!--ROW OPENED-->
							<div class="row">
								<div class="col-md-12">
									<div class="card">
										<div class="card-body p-4">
											<div class="d-flex align-items-center justify-content-between">
												<h4 class="m-0">Tous les carburants</h4>
												<div class="btn-list">
													<a class="btn btn-outline-primary" href="carburant">
														<svg xmlns="http://www.w3.org/2000/svg" class="w-inner-icn" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M21.5,13h-8.0005493C13.2234497,13.0001831,12.9998169,13.223999,13,13.5v8.0005493C13.0001831,21.7765503,13.223999,22.0001831,13.5,22h8.0006104C21.7765503,21.9998169,22.0001831,21.776001,22,21.5v-8.0006104C21.9998169,13.2234497,21.776001,12.9998169,21.5,13z M21,21h-7v-7h7V21z M10.5,2H2.4993896C2.2234497,2.0001831,1.9998169,2.223999,2,2.5v8.0005493C2.0001831,10.7765503,2.223999,11.0001831,2.5,11h8.0006104C10.7765503,10.9998169,11.0001831,10.776001,11,10.5V2.4993896C10.9998169,2.2234497,10.776001,1.9998169,10.5,2z M10,10H3V3h7V10z M10.5,13H2.4993896C2.2234497,13.0001831,1.9998169,13.223999,2,13.5v8.0005493C2.0001831,21.7765503,2.223999,22.0001831,2.5,22h8.0006104C10.7765503,21.9998169,11.0001831,21.776001,11,21.5v-8.0006104C10.9998169,13.2234497,10.776001,12.9998169,10.5,13z M10,21H3v-7h7V21z M21.5,2h-8.0005493C13.2234497,2.0001831,12.9998169,2.223999,13,2.5v8.0005493C13.0001831,10.7765503,13.223999,11.0001831,13.5,11h8.0006104C21.7765503,10.9998169,22.0001831,10.776001,22,10.5V2.4993896C21.9998169,2.2234497,21.776001,1.9998169,21.5,2z M21,10h-7V3h7V10z"/></svg>
													</a>
													<a class="btn btn-primary" href="#">
														<svg xmlns="http://www.w3.org/2000/svg" class="w-inner-icn text-white" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M3.5,12C3.223877,12,3,12.223877,3,12.5S3.223877,13,3.5,13S4,12.776123,4,12.5S3.776123,12,3.5,12z M6.5,8h15C21.776123,8,22,7.776123,22,7.5S21.776123,7,21.5,7h-15C6.223877,7,6,7.223877,6,7.5S6.223877,8,6.5,8z M3.5,17C3.223877,17,3,17.223877,3,17.5S3.223877,18,3.5,18S4,17.776123,4,17.5S3.776123,17,3.5,17z M21.5,12h-15C6.223877,12,6,12.223877,6,12.5S6.223877,13,6.5,13h15c0.276123,0,0.5-0.223877,0.5-0.5S21.776123,12,21.5,12z M3.5,7C3.223877,7,3,7.223877,3,7.5S3.223877,8,3.5,8S4,7.776123,4,7.5S3.776123,7,3.5,7z M21.5,17h-15C6.223877,17,6,17.223877,6,17.5S6.223877,18,6.5,18h15c0.276123,0,0.5-0.223877,0.5-0.5S21.776123,17,21.5,17z"/></svg>
													</a>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-12 col-sm-12">
									<div class="card" id="carburant-{{ carburant.id }}">
										<div class="card-body project-list-table-container">
											<div class="table-responsive">
												<table id="project-table" class="table text-nowrap mb-0 table-bordered border-top border-bottom project-list-main">
													<thead class="table-head">
														<tr>
															<th class="bg-transparent border-bottom-0 w-5"></th>
															<th class="bg-transparent border-bottom-0">Nom du carburant</th>
															<th class="bg-transparent border-bottom-0">Type carburant</th>
															<th class="bg-transparent border-bottom-0">Quantités</th>
															<th class="bg-transparent border-bottom-0">Coûts</th>
															<th class="bg-transparent border-bottom-0">Date d’approvisionnement</th>
															<th class="bg-transparent border-bottom-0 no-btn">Action</th>
														</tr>
													</thead>
													<tbody class="table-body">
                                                        {% for data in data %}
                                                        {% for carburant in data.carburants %}
														<tr>
															<td class="text-muted fs-15 fw-semibold text-center">{{ forloop.counter }}</td>
															<td>
																<h6 class="mb-0 fs-14 fw-semibold"><a href="#" class="float-start">{{ carburant.nom }}</h6>
															</td>
															<td class="text-muted fs-15 fw-semibold">{{ carburant.type }}</td>
															<td class="text-muted fs-15 fw-semibold">{{ carburant.quantite }}</td>
															<td class="text-muted fs-15 fw-semibold">{{ carburant.cout }}</td>
															<td class="text-muted fs-15 fw-semibold">{{ carburant.date_approvisionnement }}</td>
															<td>
																<div class="d-flex align-items-stretch">
																	<a class="btn btn-sm btn-outline-secondary border me-2" data-bs-toggle="tooltip" onclick="deleteCarburant({{ carburant.id }})" data-bs-original-title="Supprimer">
																		<svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="16"><path d="M0 0h24v24H0V0z" fill="none" /><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4h-3.5z" /></svg>
																	</a>
                                                                    <a class="btn btn-sm btn-outline-secondary border me-2" data-bs-toggle="tooltip" href="javascript:void(0)" onclick="openEditModal({{ carburant.id }})" data-bs-original-title="Modifier">
																		<svg height="24" viewBox="0 0 24 24" width="24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M17.25 10.9921C15.129 11.6991 12.3009 8.87105 13.0079 6.75M13.8793 5.87857L9.30971 10.4482C7.3231 12.4348 5.91376 14.924 5.23236 17.6496L5.01156 18.5328C4.94276 18.808 5.19204 19.0572 5.46723 18.9884L6.35044 18.7676C9.07604 18.0862 11.5652 16.6769 13.5518 14.6903L18.1214 10.1207C18.684 9.55813 19 8.79516 19 7.99962C19 6.34297 17.657 5 16.0004 5C15.2048 5 14.4419 5.31603 13.8793 5.87857Z" stroke="none" stroke-width="1.5"></path> </g></svg>
																	</a>
																	{% comment %} <a href="project-details" class="border br-5 px-2 py-1 text-muted d-flex align-items-center" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fe fe-more-vertical"></i></a>
																	<div class="dropdown-menu dropdown-menu-start">
																		<a class="dropdown-item" href="project-details"><i class="fe fe-edit-2 me-2"></i>Modifier</a>
																		<a class="dropdown-item" href="#"><i class="fe fe-share me-2"></i> Suspend</a>
																		<a class="dropdown-item" href="javascript:void(0)" onclick="deleteCarburant({{ carburant.id }})">
                                                                            <i class="fe fe-trash me-2"></i>Supprimer
                                                                        </a> 
																	</div> {% endcomment %}
                                                                    <script>
                                                                        function deleteCarburant(carburantId) { 
                                                                            Swal.fire({
                                                                                title: 'Êtes-vous sûr ?',
                                                                                text: "Voulez-vous vraiment supprimer ce carburant ?",
                                                                                icon: 'warning',
                                                                                icon: 'warning',
                                                                                showCancelButton: true,
                                                                                confirmButtonText: 'Oui, supprimer !',
                                                                                cancelButtonText: 'Annuler',
                                                                                customClass: {
                                                                                    confirmButton: 'btn btn-primary',  // Green button for confirm
                                                                                    cancelButton: 'btn btn-danger'     // Red button for cancel
                                                                                },
                                                                            }).then((result) => {
                                                                                if (result.isConfirmed) {
                                                                                    fetch(`/delete-carburant/${carburantId}/`, {
                                                                                        method: 'DELETE',
                                                                                        headers: {
                                                                                            'X-CSRFToken': '{{ csrf_token }}',  // CSRF token for Django
                                                                                            'Content-Type': 'application/json'
                                                                                        },
                                                                                    }).then(response => {
                                                                                        if (response.ok) {
                                                                                            Swal.fire(
                                                                                                'Supprimé!',
                                                                                                'Le carburant a été supprimé avec succès.',
                                                                                                'success'
                                                                                            ).then(() => {
                                                                                                location.reload();  // Reload the page to reflect the changes
                                                                                            });
                                                                                        } else {
                                                                                            Swal.fire(
                                                                                                'Erreur!',
                                                                                                'Une erreur est survenue lors de la suppression du carburant.',
                                                                                                'error'
                                                                                            );
                                                                                        }
                                                                                    }).catch(error => {
                                                                                        console.error('Error:', error);
                                                                                        Swal.fire(
                                                                                            'Erreur!',
                                                                                            'Une erreur est survenue lors de la suppression du carburant.',
                                                                                            'error'
                                                                                        );
                                                                                    });
                                                                                }
                                                                            });
                                                                        } 
                                                                    </script>
																</div>
															</td>
														</tr>
                                                        {% endfor %}
                                                        {% endfor %}
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div><!-- COL END -->
							</div>
							<!--ROW CLOSED-->

        {% endblock %}
		 
		{% block modal %}
		<!--Modal Modifier Carburant-->

        <div class="modal fade" id="editCarburantModal" tabindex="-1" aria-labelledby="editCarburantModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                            <img src="{% static 'assets/images/icons/camion-de-carburant.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                        </div>
                        <h5 class="modal-title" id="editCarburantModalLabel">Modifier Carburant</h5>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" ><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-carburant-form" method="POST">
                            {% csrf_token %}
                            <input type="hidden" id="carburant-id" name="carburant-id">
                            
                            <div class="form-row">
                                <div class="col-md-6 mb-3">
                                    <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                        <img src="{% static 'assets/images/icons/pompe-carburant.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                    </div>
                                    <label for="edit-nom">Nom :</label>
                                    <input type="text" class="form-control" id="edit-nom" name="nom" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                        <img src="{% static 'assets/images/icons/pompe-a-carburant.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                    </div>
                                    <label for="edit-type">Type :</label>
                                    <select class="form-control" id="edit-type" name="type" required>
                                        <option value="" selected disabled>Choisissez un type de carburant</option>
                                        {% for data in data %}
                                            {% for type in data.types %}
                                                <option value="{{ type.type_carburant }}" {% if type.type_carburant == carburant.type %}selected{% endif %}>
                                                    {{ type.type_carburant }}
                                                </option>
                                            {% endfor %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>                           
        
                            <div class="form-row">
                                <div class="col-md-6 mb-3">
                                    <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                        <img src="{% static 'assets/images/icons/compteur-de-carburant.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                    </div>
                                    <label for="edit-quantite">Quantité :</label>
                                    <input type="number" class="form-control" id="edit-quantite" name="quantite" required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                        <img src="{% static 'assets/images/icons/euro.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                    </div>
                                    <label for="edit-cout">Coût :</label>
                                    <input type="number" class="form-control" id="edit-cout" name="cout" required>
                                </div>
                            </div>
        
                            <div class="form-row">
                                <div class="col-md-6 mb-3">
                                    <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                        <img src="{% static 'assets/images/icons/calendrier.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                    </div>
                                    <label for="edit-date">Date d'approvisionnement :</label>
                                    <input type="date" class="form-control" id="edit-date" name="date_approvisionnement" required>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!--/Modal Modifier Carburant-->					
		{% endblock %}

    {% block scripts %}

	<script>
        function openEditModal(carburantId) {
            // Récupérer les données du carburant à modifier via une requête AJAX
            fetch(`/get-carburant/${carburantId}/`)
                .then(response => response.json())
                .then(data => {
                    // Pré-remplir les champs du formulaire avec les données du carburant
                    document.getElementById('carburant-id').value = data.id;
                    document.getElementById('edit-nom').value = data.nom;
                    document.getElementById('edit-type').value = data.type;
                    document.getElementById('edit-quantite').value = data.quantite;
                    document.getElementById('edit-cout').value = data.cout;
                    document.getElementById('edit-date').value = data.date_approvisionnement;
    
                    // Ouvrir le modal
                    var editModal = new bootstrap.Modal(document.getElementById('editCarburantModal'));
                    editModal.show();
                })
                .catch(error => console.error('Erreur:', error));
        }
    
        // Envoyer les modifications via AJAX
        document.getElementById('edit-carburant-form').addEventListener('submit', function(e) {
            e.preventDefault();  // Empêcher le rechargement de la page
    
            const carburantId = document.getElementById('carburant-id').value;
    
            const formData = {
                nom: document.getElementById('edit-nom').value,
                type: document.getElementById('edit-type').value,
                quantite: document.getElementById('edit-quantite').value,
                cout: document.getElementById('edit-cout').value,
                date_approvisionnement: document.getElementById('edit-date').value,
            };
    
            fetch(`/edit-carburant/${carburantId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(formData),
            }).then(response => {
                if (response.ok) {
                    alert("Carburant modifié avec succès");
                    location.reload();  // Recharger la page pour voir les changements
                } else {
                    alert("Erreur lors de la modification");
                }
            }).catch(error => console.error('Erreur:', error));
        });
    </script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<!-- INTERNAL DATA-TABLES JS-->
		<script src=" {% static 'assets/plugins/datatable/js/jquery.dataTables.min.js' %} "></script>
		<script src=" {% static 'assets/plugins/datatable/js/dataTables.bootstrap5.js' %} "></script>
		<script src=" {% static 'assets/plugins/datatable/dataTables.responsive.min.js' %} "></script>

		<!-- INTERNAL SELECT2 JS -->
		<script src=" {% static 'assets/plugins/select2/select2.full.min.js' %} "></script>

		<!-- PROJECT-LIST JS-->
		<script src=" {% static 'assets/js/carburant-list.js' %} "></script>

        <!-- THEMECOLORS JS -->
        <script src="{% static 'assets/js/themeColors.js'%}"></script>

    {% endblock %}



