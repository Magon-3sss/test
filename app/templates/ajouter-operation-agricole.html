{% extends 'components/base.html' %}
{% load static %}

    {% block styles %}

    {% endblock %}
    
        {% block content %}

        <!-- leaflet css  -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        

    <style>
      .leaflet-popup-content {
        width: 500px;
      }
    </style>

    <style>
      html {
        height: 100vh;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style> 
  
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      
      #map {
        width: 100%;
        height: 50vh;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
      }
      
      .info {
        padding: 6px 8px;
        font: 12px/14px Arial, Helvetica, sans-serif;
        color: white;
        background: rgba(52,58,64,0.8);
        box-shadow: 0 0 15px rgba(255,255,255,0.2);
        border-radius: 5px;
        text-align: left;
      }             

      .coordinate {
        position: absolute;
        bottom: 10px;
        right: 50%;
      }
  
      .leaflet-popup-content-wrapper {
        background-color: #000000;
        color: #fff;
        border: 1px solid red;
        border-radius: 0px;
      }
      .img{
        width:30px;
    }
    </style>
        
              <!-- PAGE-HEADER -->
              <div class="page-header">
                <input id="data-id" style="display: none;" value="{{ data }}" />
                <div>
                  <h1 class="page-title">Ajouter Opération Agricole</h1>
                </div>
                <div class="ms-auto pageheader-btn">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="javascript:void(0);">Opérations Agricoles</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Opération Utilisateur</li>
                    <li class="breadcrumb-item active" aria-current="page">Ajouter Opération Agricole</li>
                  </ol>
                </div>
              </div>
              <!-- PAGE-HEADER END -->

              <!--Row open-->
              <form id="operation" method="POST"  enctype="multipart/form-data">
                {% csrf_token %}
              <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header border-bottom">
                      <h3 class="card-title">Ajouter Opération Agricole</h3>
                    </div>
                    <div class="card-body">
                      <div id="smartwizard-3">
                        <ul>
                          <li><a href="#step-10">Emplacement</a></li>
                          <li><a href="#step-11">Type d'opération</a></li>
                          <li><a href="#step-12" >Main d'oeuvre</a></li>
                          <li><a href="#step-13">Machines et carburants</a></li>
                          <li><a href="#step-14">Outils agricoles</a></li>
                          <li><a href="#step-15">Pièces de rechange</a></li>
                          <li><a href="#step-16">Graines</a></li>
                          <li><a href="#step-17">Fertilisants</a></li>
                          <li><a href="#step-18">Traitements</a></li>
                          <li><a href="#step-19">Note</a></li>
                        </ul>
                        <div>
                          <div id="step-10">
                            <form >
                              <div class="form-group">
                                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                  <img src="{% static 'assets/images/icons/emplacement.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                </div>
                                                                <label for="inputtext">Emplacement</label>
                                                                <div class="col-md-6 mb-3">
                                                                   <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                                                    <img src="{% static 'assets/images/icons/project-management.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                                                   </div> 
                                                                   <label for="geozone">Projets </label>
                                                                    {% comment %} <select class="form-control" id="geozone" name="project_id" required>
                                                                      <option value="" selected disabled>Projet 1</option>
                                                                      {% for data in data %}
                                                                          {% for projet in data.projects %}
                                                                              <option value="{{ projet.id }}">{{ projet.project_name }}</option>
                                                                          {% endfor %}
                                                                      {% endfor %}
                                                                    </select> {% endcomment %}                                                                
                                                                    <select class="form-control" id="geozone" name="project_id" required>
                                                                        <option value="" selected disabled>Projet 1</option>
                                                                        {% for data in data %}
                                                                            {% for projet in data.projects %}
                                                                            <option value="{{ projet.geozone_id }}">{{ projet.project_name }}</option>
                                                                            {% endfor %}
                                                                        {% endfor %}
                                                                    </select>
                                                                
                                                                  </div>

                                                                  <script>
                                                                    function updateMapPoints(geozoneId) {
                                                                        // Supprimez tous les tracés existants
                                                                        map.eachLayer(function(layer) {
                                                                            if (layer instanceof L.Polyline) {
                                                                                map.removeLayer(layer);
                                                                            }
                                                                        });
                                                                
                                                                        // Faites une requête AJAX pour récupérer les points du projet sélectionné
                                                                        fetch('/api/get-points/' + geozoneId)
                                                                            .then(response => response.json())
                                                                            .then(data => {
                                                                                // Convertissez les données en un tableau de coordonnées LatLng
                                                                                var latlngs = data.map(function(point) {
                                                                                    return [parseFloat(point.latt), parseFloat(point.long)];
                                                                                });
                                                                
                                                                                // Tracez la ligne sur la carte
                                                                                var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map);
                                                                
                                                                                // Calculez le rectangle englobant des points
                                                                                var bounds = polyline.getBounds();
                                                                
                                                                                // Ajustez la vue de la carte sur le rectangle englobant
                                                                                map.fitBounds(bounds);
                                                                            });
                                                                    }
                                                                
                                                                    // Écoutez les changements de sélection dans le menu déroulant
                                                                    document.getElementById('geozone').addEventListener('change', function() {
                                                                        var selectedGeozoneId = this.value;
                                                                        updateMapPoints(selectedGeozoneId);
                                                                    });
                                                                </script>

                                                                <div id="map">
                                                                    <!-- Map coordinate  -->
                                                                    <div class="leaflet-control map-coordinate">
                                                                        <div class="coordinate"></div>
                                                                    </div>
                                                            </div>
                                                                    <!-- leaflet js  -->
                                                                    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
                                                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
                                                                    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
                                                                    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
                                                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
                                                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                                                                    <script src="{% static './lib/leaflet.markercluster.js' %}"></script>
                                                                    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
                                                                    <script src="{% static './data/test.js' %}"></script>
                                                                    <script src="{% static './dist/main.js' %}"></script>
                                                                    <script src="{% static './dist/web-GIS.js' %}"></script>
                                        
                                                                    <!-- leaflet draw plugin  -->
                                                                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
                                                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
                                                         
                                        <script>
                                            // Map initialization 
                                            var mapcenter = [51.505, -0.09];
                                            var map = L.map('map', {zoomControl: false}).setView(mapcenter, 11);
                                        
                                            //google satellite
                                            googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                                                maxZoom: 20,
                                                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                                            });googleSat.addTo(map)
                                        
                                            // Zoom Control
                                            var zoomControl = L.control.zoom({
                                                position: "topleft"
                                            });
                                            zoomControl.addTo(map);  
                                        
                                            // leaflet draw 
                                            var drawnItems = new L.FeatureGroup();
                                            map.addLayer(drawnItems);
                                        
                                            var drawControl = new L.Control.Draw({
                                                // position: "topright",
                                                edit: {
                                                    featureGroup: drawnItems,
                                                    poly : {
                                                        allowIntersection : false
                                                      }
                                                },
                                                draw: {
                                                    
                                                    polyline: {
                                                     shapeOptions: {
                                                      color: 'red'
                                                     },
                                                    },
                                                    rect: {
                                                     shapeOptions: {
                                                      color: 'green'
                                                     },
                                                    },
                                                    circle: {
                                                     shapeOptions: {
                                                      color: 'steelblue'
                                                     },
                                                    },
                                                   },
                                         
                                            });
                                            map.addControl(drawControl);
                                        
                                            //new part
                                        
                                            map.on("draw:created", function(e){
                                            
                                                var type = e.layerType;
                                                console.log('Type: '+type);
                                                var layer = e.layer;
                                                console.log(layer);
                                                let coordinates = layer.toGeoJSON().geometry.coordinates;
                                                console.log(coordinates);
                                                
                                                
                                                if(type === 'polyline'){
                                                    let data = {
                                                        type: type,
                                                        coordinates: coordinates
                                                    }
                                                    console.log(data);
                                                localStorage.setItem('data', JSON.stringify(data));
                                                console.log(localStorage.getItem('data'));
                                                layer.bindPopup(`<p>${JSON.stringify(layer.toGeoJSON())}</p>`)
                                                drawnItems.addLayer(layer);
                                                }
                                                if(type === 'polygon' || type === 'rectangle'){
                                                    var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs(),
                                                    area = L.GeometryUtil.geodesicArea(latlngs);
                                                    poly_area = L.GeometryUtil.readableArea(area, true);
                                                    console.log(poly_area);
                                                    let data = {
                                                        type: type,
                                                        coordinates: coordinates,
                                                        area: poly_area
                                                    }
                                                    console.log(data);
                                                localStorage.setItem('data', JSON.stringify(data));
                                                console.log(localStorage.getItem('data'));
                                                layer.bindPopup(`<p>${JSON.stringify(layer.toGeoJSON())}</p>`)
                                                drawnItems.addLayer(layer);
                                                }
                                                if(type === 'circle'){
                                                    let radius = layer.getRadius();
                                                    console.log('L257: '+radius);
                                                    let pi = Math.PI;
                                                    let area = pi * (radius*radius);
                                                    console.log(area);
                                                    let new_area = (Math.round(area * 100) / 100).toFixed(2);
                                                    console.log(new_area);
                                                    
                                                    let data = {
                                                        type: type,
                                                        coordinates: coordinates,
                                                        area: new_area,
                                                        circle_radius: radius
                                                    }
                                                    console.log(data);
                                                localStorage.setItem('data', JSON.stringify(data));
                                                console.log(localStorage.getItem('data'));
                                                layer.bindPopup(`<p>${JSON.stringify(layer.toGeoJSON())}</p>`)
                                                drawnItems.addLayer(layer);
                                                }
                                                if(type === 'marker'){
                                                    
                                                    let data = {
                                                        type: type,
                                                        coordinates: coordinates
                                                    }
                                                    console.log(data);
                                                localStorage.setItem('data', JSON.stringify(data));
                                                console.log(localStorage.getItem('data'));
                                                layer.bindPopup(`<p>${JSON.stringify(layer.toGeoJSON())}</p>`)
                                                drawnItems.addLayer(layer);
                                                }
                                            });
                                        
                                            map.on("draw:edited", function(e){
                                                var type = e.layerType;
                                                console.log('Type: '+type);
                                                var layer = e.layer;
                                                console.log(layer);    
                                            })
                                        
                                             // Object(s) deleted - update console log
                                        map.on(L.Draw.Event.DELETED, function(event) {
                                            console.log(JSON.stringify(drawnItems.toGeoJSON()));
                                            //drawControl.addTo(map);
                                          });

                                          map.on(L.Draw.Event.CREATED, function(event) {
                                            var layer = event.layer;
                                            var type = event.layerType;
                                        
                                            // Obtenez les coordonnées sous forme de latitude et longitude
                                            var latlng = layer.getLatLng(); // Fonction spécifique pour les points (marker)
                                            var latitude = latlng.lat;
                                            var longitude = latlng.lng;

                                            // Dynamically add the latitude and longitude to the form
                                            var form = document.getElementById('operation');
                                            var latInput = document.createElement('input');
                                            latInput.type = 'hidden';
                                            latInput.name = 'marker_latitude[]';
                                            latInput.value = latitude;
                                            form.appendChild(latInput);

                                            var lngInput = document.createElement('input');
                                            lngInput.type = 'hidden';
                                            lngInput.name = 'marker_longitude[]';
                                            lngInput.value = longitude;
                                            form.appendChild(lngInput);
                                        
                                            // Obtenez l'ID du projet sélectionné
                                            var selectedGeozoneId = document.getElementById('geozone').value;
                                        
                                            // Créez l'objet de données à envoyer
                                            var data = {
                                                project_id: selectedGeozoneId,
                                                type: type,
                                                latitude: latitude,
                                                longitude: longitude
                                            };
                                        
                                            // Faites une requête AJAX pour envoyer les données au serveur
                                            fetch('/api/save-marker/', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'X-CSRFToken': '{{ csrf_token }}'
                                                },
                                                body: JSON.stringify(data)
                                            })
                                            .then(response => response.json())
                                            .then(data => {
                                                console.log('Success:', data);
                                                layer.bindPopup(`Marker ID: ${data.id}`).openPopup();
                                                drawnItems.addLayer(layer);
                                            })
                                            .catch(error => {
                                                console.error('Error:', error);
                                            });
                                        });
                                        
                                        
                                          // fin new part
                                        
                                            // Truncate value based on number of decimals
                                         var _round = function(num, len) {
                                            return Math.round(num*(Math.pow(10, len)))/(Math.pow(10, len));
                                          };
                                          // Helper method to format LatLng object (x.xxxxxx, y.yyyyyy)
                                          var strLatLng = function(latlng) {
                                            return "("+_round(latlng.lat, 6)+", "+_round(latlng.lng, 6)+")";
                                          };
                                          
                                          // Generate popup content based on layer type
                                          // - Returns HTML string, or null if unknown object
                                          var getPopupContent = function(layer) {
                                            // Marker - add lat/long
                                            if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                                              return strLatLng(layer.getLatLng());
                                            // Circle - lat/long, radius
                                            } else if (layer instanceof L.Circle) {
                                              var center = layer.getLatLng(),
                                                radius = layer.getRadius();
                                              return "Center: "+strLatLng(center)+"<br />"
                                                +"Radius: "+_round(radius, 2)+" m";
                                            // Rectangle/Polygon - area
                                            } else if (layer instanceof L.Polygon) {
                                              var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs(),
                                                area = L.GeometryUtil.geodesicArea(latlngs);
                                              return "Area: "+L.GeometryUtil.readableArea(area, true);
                                            // Polyline - distance
                                            } else if (layer instanceof L.Polyline) {
                                              var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs(),
                                                distance = 0;
                                              if (latlngs.length < 2) {
                                                return "Distance: N/A";
                                              } else {
                                                for (var i = 0; i < latlngs.length-1; i++) {
                                                  distance += latlngs[i].distanceTo(latlngs[i+1]);
                                                }
                                                if (_round(distance, 2) > 1000) {
                                                  return "Distance: "+_round(distance, 2)/1000 + " km"; // kilometers
                                                } else {
                                                  return "Distance: "+_round(distance, 2) + " m"; // meters
                                                }
                                              }
                                            }
                                            return null;
                                          };
                                          
                                          // Object created - bind popup to layer, add to feature group
                                          map.on(L.Draw.Event.CREATED, function(event) {
                                            var layer = event.layer;
                                            var content = getPopupContent(layer);
                                            if (content !== null) {
                                              layer.bindPopup(content);
                                            }
                                          
                                            // Add info to feature properties
                                            feature = layer.feature = layer.feature || {};
                                            feature.type = feature.type || "Feature";
                                            var props = feature.properties = feature.properties || {}; // Intialize feature.properties
                                            props.info = content;
                                            drawnItems.addLayer(layer);
                                            console.log(JSON.stringify(drawnItems.toGeoJSON()));
                                          });
                                          
                                          // Object(s) edited - update popups
                                          map.on(L.Draw.Event.EDITED, function(event) {
                                            var layers = event.layers,
                                              content = null;
                                            layers.eachLayer(function(layer) {
                                              content = getPopupContent(layer);
                                              if (content !== null) {
                                                layer.setPopupContent(content);
                                              }
                                          
                                              // Update info to feature properties
                                              var layer = layer;
                                              feature = layer.feature = layer.feature || {};
                                              var props = feature.properties = feature.properties || {};
                                              props.info = content;
                                            });
                                            console.log(JSON.stringify(drawnItems.toGeoJSON()));
                                          });
                                          
                                          // Object(s) deleted - update console log
                                          map.on(L.Draw.Event.DELETED, function(event) {
                                            console.log(JSON.stringify(drawnItems.toGeoJSON()));
                                            //drawControl.addTo(map);
                                          });
                                        
                                            map.on("draw:created", function(e){
                                                //drawControl.removeFrom(map);
                                                var type = e.layerType;
                                                var layer = e.layer;
                                                console.log(layer.toGeoJSON())
                                        
                                                layer.bindPopup(`<p>${JSON.stringify(layer.toGeoJSON())}</p>`)
                                                drawnItems.addLayer(layer);
                                            });
                                        
                                            map.on("draw:edited", function(e){
                                                var layers = e.layers;
                                                var type = e.layerType;
                                                layers.eachLayer(function(layer){
                                                    console.log(layer)
                                                })    
                                            })
                                           
                                        
                                        
                                            // water color 
                                            var watercolor = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.{ext}', {
                                                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                                                subdomains: 'abcd',
                                                minZoom: 1,
                                                maxZoom: 16,
                                                ext: 'jpg'
                                            });
                                            // watercolor.addTo(map)
                                        
                                            // google street 
                                            googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                                                maxZoom: 20,
                                                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                                            });
                                            //googleStreets.addTo(map);
                                        
                                         var baselayer = {
                                            "Satellite": googleSat,
                                            "Street": googleStreets,
                                            /*"water color": watercolor,*/ 
                                            
                                            "Street": googleStreets
                                         }
                                        
                                         L.control.layers(baselayer, /*overlayers*/).addTo(map)
                                        
                                        
                                         // sideBySide 
                                         L.control.sideBySide(ls, mf).addTo(map);
                                        </script>
                                    </div>
                                    </div>
                                    
                                    <div id="step-11">
                                    <form >
                                      <div class="form-row">
                                        <div class="col-md-4 mb-6">
                                            <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                              <img src="{% static 'assets/images/icons/agriculteur.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                            </div>
                                            <label for="type">Type d'opération </label>
                                                      <select class="form-control" name="typeoperation" id="typeoperation" data-placeholder="choisir votre opération" required>
                                                          <option value="Irrigation">Irrigation</option>
                                                          <option value="Fertilisation">Fertilisation</option>
                                                          <option value="Récolte">Récolte</option>
                                                          <option value="Traitement">Traitement</option>
                                                          <option value="Autre">Autre</option>
                                                      </select>
                                         </div>
                                     
                                                    <div class="col-md-4 mb-6">
                                                      <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                                        <img src="{% static 'assets/images/icons/calendrier.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                                      </div>
                                                      <label for="datetime">Date et Heure de l'opération </label>
                                                      <input type="datetime-local" class="form-control" id="date_debut" name="date_debut">
                                                    </div>
                                                    <div class="col-md-4 mb-6">
                                                    <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                                      <img src="{% static 'assets/images/icons/calendrier.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                                    </div>
                                                    <label for="datetime">Date et Heure de fin d'opération </label>
                                                    <input type="datetime-local" class="form-control" id="date_fin" name="date_fin">
                                                    </div>
                                      </div> 
                                        
                          </div>       
                          <div id="step-12">
                            <form >
                              <div class="form-row">
                                <div class="col-md-4 mb-6">
                                  <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                    <img src="{% static 'assets/images/icons/externalisation-rh.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                  </div>
                                  <label for="type">Main d'oeuvre</label>
                                    <select class="form-control" id="type_rh" name="type_rh[]">
                                        <option value="" selected disabled>Ouvrier</option>
                                        {% for rh in data.0.type_rh %}
                                            <option value="{{ rh.id }}">{{ rh.nom }} {{ rh.prenom }} ({{ rh.type }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-6">
                          <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                            <img src="{% static 'assets/images/icons/lhorloge.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                          </div>
                          <label for="datetime">Date et Heure de début</label>
                          <input type="datetime-local" class="form-control" id="time" name="time[]">
                                </div>
            
                                <div class="col-md-4 mb-6">
                                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                  <img src="{% static 'assets/images/icons/lhorloge.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                                </div>
                                <label for="datetime">Date et Heure de fin </label>
                                <input type="datetime-local" class="form-control" id="timefin" name="timefin[]">
                                </div>
                              </div>
                              {% comment %} <div class="form-row"> {% endcomment %}
                                <div >
                              <div id="additional-fields-container"></div>
                              <button type="button" class="btn btn-info" onclick="addFields()"><i class="fe fe-plus me-2"></i>Ajouter des champs</button>
                            {% comment %} </div> {% endcomment %}
                          </div>
                            </form>
                          </div>
                          <div id="step-13">
                            <div class="form-row">
                              <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/pelouse.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="type_machine_engins">Type machine</label>
                              <select class="form-control" id="type_machine_engins" name="type_machine_engins[]" >
                              <option value="" selected disabled>Camion</option>
                              {% for machine in data.0.machines_tables %}
                              <option value="{{ machine.id }}">{{ machine.type }} ({{ machine.matricule }})</option>
                              {% endfor %}
                              </select>
                            </div>
                            <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/carburant.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="carburant">Carburant </label>
                              <select class="form-control" id="carburant" name="carburant[]" >
                              <option value="" selected disabled>Gaz</option>
                              {% for data in data %}
                                  {% for carburant in data.carburants %}
                                  <option value="{{ carburant.type_carburant }}">{{ carburant.type_carburant }}</option>
                                  {% endfor %}
                              {% endfor %}
                              </select>
                            </div>
                            <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/duree.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="duree du programme">Date et Heure de début</label>
                                <input type="datetime-local" class="form-control" id="duree_utilisation_programme" name="duree_utilisation_programme[]">
                            </div>
                            <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/duree.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="heure_de_fin">Date et Heure de fin </label>
                                <input type="datetime-local" class="form-control" id="heure_de_fin" name="heure_de_fin[]">
                            </div>
                            <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/jauge.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="quantite_carburant">Quantité carburant en litres</label>
                              <input type="number" class="form-control" id="quantite_carburant"  name= "quantite_carburant[]" placeholder="quantite_du_carburant">
                            </div>
                          </div>
                          {% comment %} <div class="form-row"> {% endcomment %}
                            <div >
                          <div id="additional-fields"></div>
                          <button type="button" class="btn btn-info" onclick="add()"><i class="fe fe-plus me-2"></i>Ajouter des champs</button>
                        {% comment %} </div> {% endcomment %}
                      </div>
                        </div>
                          <div id="step-14">
                            <div class="form-row">
                              <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/outils-de-jardinage.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="outil">Outil </label>
                                <select class="form-control"  id="outil" name="outil[]">
                                <option value="" selected disabled>Pelle</option>
                                {% for data in data %}
                                    {% for outil in data.outils %}
                                    <option value="{{ outil.type_outils_agricoles }}">{{ outil.type_outils_agricoles }}</option>
                                    {% endfor %}
                                {% endfor %}
                                </select>
                              </div>
                            </div>
                            {% comment %} <div class="form-row"> {% endcomment %}
                              <div >
                            <div id="ajouter"></div>
                            <button type="button" class="btn btn-info" onclick="ajouter()"><i class="fe fe-plus me-2"></i>Ajouter des champs</button>
                          {% comment %} </div> {% endcomment %}
                        </div>
                          </div>
                          <div id="step-15">
                            <div class="form-row">
                              <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/achat.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="piece">Pièce de rechange </label>
                                <select class="form-control" id="type_pieces" name="type_pieces[]" >
                                <option value="" selected disabled>A</option>
                                {% for data in data %}
                                    {% for piece in data.pieces %}
                                    <option value="{{ piece.type_pieces }}">{{ piece.type_pieces }}</option>
                                    {% endfor %}
                                {% endfor %}
                                </select>
                             </div>
                             <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/duree.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="duree_utilisation">Nombre de pièces</label>
                              <input type="number" class="form-control" id="nombre_de_pieces_${fieldCount}"  name="nombre_de_pieces[]" placeholder="nombre_de_pieces">
                             </div> 
                            </div>
                            {% comment %} <div class="form-row"> {% endcomment %}
                              <div >
                            <div id="ajouterfield"></div>
                            <button type="button" class="btn btn-info" onclick="ajouterfield()"><i class="fe fe-plus me-2"></i>Ajouter des champs</button>
                          {% comment %} </div> {% endcomment %}
                        </div>
                          </div>
                          <div id="step-16">
                            <div class="form-row">
                              <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/sac-de-graines.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="graine">Graines </label>
                              <select class="form-control" id="type_graines_pousses" name="type_graines_pousses" >
                              <option value="" selected disabled>graine</option>
                              {% for data in data %}
                                  {% for graine in data.graines %}
                                  <option value="{{ graine.type_graines_pousses }}">{{ graine.type_graines_pousses }}</option>
                                  {% endfor %}
                              {% endfor %}
                              </select>
                            </div>
                            <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/grains-de-cafe.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="quantite_graine_utilisee">Quantité utilisée de graines en KG </label>
                              <input type="nimber" class="form-control" id="quantite_graine_utilisee" name="quantite_graine_utilisee" placeholder="quantite utilisee">
                            </div>
                            </div>
                          </div>
                           <div id="step-17">
                            <div class="form-row">
                              <div class="col-md-4 mb-3">
                            <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                              <img src="{% static 'assets/images/icons/engrais.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                            </div>
                            <label for="engrais">Engrais </label>
                            <select class="form-control" id="type_engrais" name="type_engrais" >
                            <option value="" selected disabled>engrais</option>
                            {% for data in data %}
                                {% for engrais in data.engraiss %}
                                <option value="{{ engrais.type_engrais }}">{{ engrais.type_engrais }}</option>
                                {% endfor %}
                            {% endfor %}
                            </select>
                              </div>
                              <div class="col-md-4 mb-3">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/grains-de-cafe.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="quantite_engrais_utilisee">Quantité engrais utilisée en KG</label>
                              <input type="number" class="form-control" id="quantite_engrais_utilisee" name="quantite_engrais_utilisee" placeholder="quantité utilisee">
                              </div>
                            </div> 
                          </div> 
                          <div id="step-18">
                            <div class="form-row">
                              <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/traitement-a-base-de-plantes.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="traitement">Traitement</label>
                                <select class="form-control" id="type_traitement" name="type_traitement" >
                                <option value="" selected disabled>traitement</option>
                                {% for data in data %}
                                    {% for traitement in data.traitements %}
                                    <option value="{{ traitement.type_traitement }}">{{ traitement.type_traitement }}</option>
                                    {% endfor %}
                                {% endfor %}
                                </select>
                              </div>
                              
                                <div class="col-md-4 mb-6">
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                <img src="{% static 'assets/images/icons/grains-de-cafe.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                              <label for="quantite_traitement_utilisee">Quantité traitement utilisée en KG </label>
                              <input type="number" class="form-control" id="quantite_traitement_utilisee" name="quantite_traitement_utilisee" placeholder="quantite utilisee">
                                </div>
                            </div>
                          </div>
                          <div id="step-19">
                            <div class="form-row">
                              <div class="col-md-6 mb-6">
                              
                              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                                  <img src="{% static 'assets/images/icons/projet.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                              </div>
                            <label for="description" >Description </label>
                            <textarea class="form-control" id="description" name="description" placeholder=" description " rows="3" ></textarea>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--row closed-->

              
              
 {% endblock %}
    

  {% block scripts %}
    <!-- FORM WIZARD JS-->
    <script src=" {% static 'assets/plugins/formwizard/jquery.smartWizard.js' %} "></script>
    <script src=" {% static 'assets/plugins/formwizard/fromwizard.js' %} "></script>

    <!-- INTERNAl JQUERY.STEPS JS -->
    <script src=" {% static 'assets/plugins/jquery-steps/jquery.steps.min.js' %} "></script>
    <script src=" {% static 'assets/plugins/parsleyjs/parsley.min.js' %} "></script>

    <!-- INTERNAL ACCORDION-WIZARD-FORM JS-->
    <script src=" {% static 'assets/plugins/accordion-Wizard-Form/jquery.accordion-wizard.min.js' %} "></script>
    <script src=" {% static 'assets/js/form-wizard.js' %} "></script>

    <!-- THEMECOLORS JS -->
    <script src="{% static 'assets/js/themeColors.js'%}"></script>
    
    <!-- bootstrap-datepicker js -->
     
     <script src=" {% static 'assets/js/projects-new.js' %} "></script> 
     

     <script src=" {% static 'assets/js/ajouter_operation_agricole.js' %} "></script>


     <script>
      let fieldCount = 0; 
    
      function addFields() {
        fieldCount++;
        const container = document.getElementById('additional-fields-container');
    
        // Crée une nouvelle section de champs avec la même structure
        const newFields = document.createElement('div');
        newFields.className = 'form-row'; // Assurez-vous que la classe est la même
        newFields.innerHTML = `
            <div class="col-md-4 mb-6">
                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle me-2">
                    <img src="{% static 'assets/images/icons/externalisation-rh.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                </div>
                <label for="type_${fieldCount}">Main d'oeuvre ${fieldCount}</label>
                <select class="form-control" id="type_rh_${fieldCount}" name="type_rh[]">
                    <option value="" selected disabled>Ouvrier</option>
                    {% for rh in data.0.type_rh %}
                        <option value="{{ rh.id }}">{{ rh.nom }} {{ rh.prenom }} ({{ rh.type }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-6">
                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle me-2">
                    <img src="{% static 'assets/images/icons/lhorloge.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                </div>
                <label for="datetime_${fieldCount}">Date et Heure de début ${fieldCount}</label>
                <input type="datetime-local" class="form-control" id="time_${fieldCount}" name="time[]">
            </div>
            <div class="col-md-4 mb-6">
                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle me-2">
                    <img src="{% static 'assets/images/icons/lhorloge.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                </div>
                <label for="datetime_${fieldCount}">Date et Heure de fin ${fieldCount}</label>
                <input type="datetime-local" class="form-control" id="timefin_${fieldCount}" name="timefin[]">
            </div>
        `;
    
        container.appendChild(newFields);
    }
      
      function add() {
        fieldCount++;
        const container = document.getElementById('additional-fields');
    
        // Crée une nouvelle section de champs
        const newFields = document.createElement('div');
        newFields.className = 'additional-fields';
        newFields.innerHTML = `
          <div class="form-row">
            <div class="col-md-4 mb-6">
              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                <img src="{% static 'assets/images/icons/pelouse.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
              </div>
              <label for="type_${fieldCount}">Type Machine ${fieldCount}</label>
              <select class="form-control" id="type_machine_engins_${fieldCount}" name="type_machine_engins[]">
              <option value="" selected disabled>Camion</option>
                              {% for machine in data.0.machines_tables %}
                              <option value="{{ machine.id }}">{{ machine.type }} ({{ machine.matricule }})</option>
                              {% endfor %}
                              </select>
            </div>
             <div class="col-md-4 mb-6">
              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                <img src="{% static 'assets/images/icons/carburant.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
              </div>
              <label for="type_${fieldCount}">Carburant ${fieldCount}</label>
              <select class="form-control" id="carburant_${fieldCount}" name="carburant[]">
             <option value="" selected disabled>Gaz</option>
                              {% for data in data %}
                                  {% for carburant in data.carburants %}
                                  <option value="{{ carburant.type_carburant }}">{{ carburant.type_carburant }}</option>
                                  {% endfor %}
                              {% endfor %}
                              </select>
            </div>
            <div class="col-md-4 mb-6">
                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                  <img src="{% static 'assets/images/icons/duree.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                </div>
              <label for="additional_description_${fieldCount}">date et heure de début ${fieldCount}</label>
              <input type="datetime-local" class="form-control" id="date et heure de début_${fieldCount}" name="duree_utilisation_programme[]">
            </div>
            <div class="col-md-4 mb-6">
              <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                <img src="{% static 'assets/images/icons/duree.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
              </div>
              <label for="additional_description_${fieldCount}">date et heure de fin ${fieldCount}</label>
              <input type="datetime-local" class="form-control" id="date et heure de fin_${fieldCount}" name="heure_de_fin[]">
            </div>
             <div class="col-md-4 mb-6">
                  <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                    <img src="{% static 'assets/images/icons/jauge.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                  </div>
              <label for="additional_description_${fieldCount}">Quantité carburant ${fieldCount}</label>
              <input type="number" class="form-control" id="quantite_carburant_${fieldCount}" name="quantite_carburant[]">
            </div>
          </div>
        `;
    
        container.appendChild(newFields);
      }
      function ajouter() {
        fieldCount++;
        const container = document.getElementById('ajouter');
        
        // Crée une nouvelle section de champs
        const newFields = document.createElement('div');
        newFields.className = 'additional-fields';
        newFields.innerHTML = `
          <div class="form-row">
            <div class="col-md-4 mb-6">
                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                  <img src="{% static 'assets/images/icons/outils-de-jardinage.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                </div>
              <label for="outil_${fieldCount}">Outil ${fieldCount}</label>
              <select class="form-control" id="outil_${fieldCount}" name="outil[]">
                <option value="" selected disabled>Pelle</option>
                {% for data in data %}
                    {% for outil in data.outils %}
                    <option value="{{ outil.type_outils_agricoles }}">{{ outil.type_outils_agricoles }}</option>
                    {% endfor %}
                {% endfor %}
              </select>
            </div> 
          </div>
        `;
        
        container.appendChild(newFields);
    } 
      function ajouterfield() {
        fieldCount++;
        const container = document.getElementById('ajouterfield');
    
        // Crée une nouvelle section de champs
        const newFields = document.createElement('div');
        newFields.className = 'additional-fields';
        newFields.innerHTML = `
          <div class="form-row">
            <div class="col-md-4 mb-6">
                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                  <img src="{% static 'assets/images/icons/achat.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                </div>
              <label for="type_${fieldCount}">Pièce de rechange ${fieldCount}</label>
              <select class="form-control" id="type_pieces_${fieldCount}" name="type_pieces[]">
              <option value="" selected disabled>A</option>
                                {% for data in data %}
                                    {% for piece in data.pieces %}
                                    <option value="{{ piece.type_pieces }}">{{ piece.type_pieces }}</option>
                                    {% endfor %}
                                {% endfor %}
                                </select>
            </div>
             <div class="col-md-4 mb-6">
                <div class="avatar mb-2 p-2 lh-1 mb-sm-0 avatar-md rounded-circle  me-2">
                  <img src="{% static 'assets/images/icons/duree.png' %}" class="side-menu__icon img" enable-background="new 0 0 24 24" viewBox="0 0 24 24"/>
                </div>
              <label for="additional_description_${fieldCount}">Nombre de pièces ${fieldCount}</label>
              <input type="number" class="form-control" id="nombre_de_pieces_${fieldCount}" name="nombre_de_pieces[]">
            </div>
             </div>
        `;
    
        container.appendChild(newFields);
      }
      
      function saveData() {
        const form = document.getElementById('form-step-1');
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
          formData[input.name] = input.value;
        });
        localStorage.setItem('formData', JSON.stringify(formData));
      }
    
      function nextStep(step) {
        saveData();
        document.querySelector(`.step:not([style*="display: none"])`).style.display = 'none';
        document.getElementById(`step-${step}`).style.display = 'block';
      }
    
      function loadData() {
        formData = JSON.parse(localStorage.getItem('formData') || '{}');
        const form = document.getElementById('form-step-1');
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
          input.value = formData[input.name] || '';
        });
      }
    
      window.onload = loadData;
    </script>
    

    {% endblock %}