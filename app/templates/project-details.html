{% extends 'components/base.html' %}
{% load static %}
    {% block styles %}
    {% endblock %}
        {% block content %}
		<style>
			.menu{
				position: absolute;
				top: 20%;
				left: 93%;
				width: 60px;
				height: 260px;
				background-color: #f3f9f9;
				border-radius: 10px;
				text-align: center;
			}
			.menu-button{
				border: none;
				cursor: pointer;
				appearance: none;
				transition: transform 0.7s ease-in-out;
				margin-top: 10px;
				background-color: none;
				border-radius: 7px;
			}
			.image_menu{
				width: 40px;
  				height: 40px;
			}
			.referencecl{
				position: absolute;
				top: 20%;
				left: 5%;
				width: 270px;
				height: 420px;
				background-color: #c8cfcf;
				border-radius: 10px;
				text-align: center;
				opacity: 0.8;
				display: block;
				overflow-y: scroll;
			}
			.hidden {
				display: none;
			}	
			/* Augmenter la taille des cellules du tableau */
			#reference-table td {
				padding: 10px; /* Ajustez cette valeur selon vos besoins */
			}

			/* Augmenter la taille des cellules de couleur */
			#reference-table .color-cell {
				width: 5px; /* Ajustez cette valeur selon vos besoins */
				height: 5px; /* Ajustez cette valeur selon vos besoins */
			}

			/* Augmenter la taille de la police */
			#reference-table td {
				font-size: 12px; /* Ajustez cette valeur selon vos besoins */
			}
		
			.reference{
				position: absolute;
				top: 20%;
				left: 5%;
				width: 270px;
				height: 420px;
				background-color: #c8cfcf;
				border-radius: 10px;
				text-align: center;
				opacity: 0.8;
				display: none;
				overflow-y: scroll;
			}
			.irrigation {
				position: absolute;
				background-color: #fff;
				border: 1px solid #ccc;
				padding: 10px;
				bottom: 25%;
				left: 5%;
				display: none;
				margin-block: -142px;
			  }
			</style>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="author" content="unsorry">
        <meta name="description" content="leaflet draw export to geojson file">
		<title>Leaflet Tutorial</title>
		{% comment %} <link rel="icon" type="image/x-icon" href="https://unsorry.net/assets-date/images/favicon.png"> {% endcomment %}
		<!-- leaflet css  -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
		<style>
            .leaflet-popup-content {
                width: 500px;
            }
        </style>
		<style>
			html {
				height: 100vh;
				width: 100%;
				margin: 0;
				padding: 0;
			}
		</style> 	
		<style>
			body {
				margin: 0;
				padding: 0;
			}			
			#map {
				width: 100%;
				height: 100vh;
				box-shadow: 0 0 10px rgba(0,0,0,0.5);
			}
			.info {
				padding: 6px 8px;
				font: 12px/14px Arial, Helvetica, sans-serif;
				color: white;
				background: rgba(52,58,64,0.8);
				box-shadow: 0 0 15px rgba(255,255,255,0.2);
				border-radius: 5px;
				text-align: left;
			}			  
			#exportBtn {
				color: #ffffff;
				font-weight: bold;
			}
			.coordinate {
				position: absolute;
				bottom: 10px;
				right: 50%;
			}	
			.leaflet-popup-content-wrapper {
				background-color: #000000;
				color: #fff;
				border: 1px solid red;
				border-radius: 0px;
			}
			#filtre-select {
				/* Styles pour personnaliser l'apparence du select */
				width: 200px; /* Ajustez la largeur selon vos besoins */
				font-family: Arial, sans-serif;
				font-size: 14px;
				border: 1px solid #ccc;
				border-radius: 5px;
				padding: 5px;
				background-color: #fff;
			}
			  
			#filtre-select optgroup {
				font-weight: bold;
			}

			#parcelle {
				/* Styles pour personnaliser l'apparence du select */
				width: 200px; /* Ajustez la largeur selon vos besoins */
				font-family: Arial, sans-serif;
				font-size: 14px;
				border: 1px solid #ccc;
				border-radius: 5px;
				padding: 5px;
				background-color: #fff;
			}
			
			.custom-select-wrapper {
				position: relative;
				display: inline-block;
			}
			
			.custom-select {
				display: flex;
				align-items: center;
				justify-content: space-between;
				width: 200px;
				height: 30px;
				border: 1px solid #ccc;
				border-radius: 4px;
				padding: 5px;
				background-color: #fff;
				cursor: pointer;
				font-size: 14px;
			}
			
			.select-items {
                position: absolute;
                background-color: #fff;
                border: 1px solid #ddd;
                z-index: 99;
                max-height: 200px;
                overflow-y: auto;
                display: none;
            }

			
			.select-items label {
				display: block;
				padding: 8px 16px;
				cursor: pointer;
			}
			
			.select-items label:hover {
				background-color: #f1f1f1;
			}
			
			.select-items input[type="checkbox"] {
				margin-right: 10px;
			}
			</style>
		
							<!-- PAGE-HEADER -->
							<div class="page-header">
								<div>
									<h1 class="page-title">Détails du projet</h1>
								</div>
								<div class="ms-auto pageheader-btn">
									<ol class="breadcrumb">
										{% comment %} <li class="breadcrumb-item">Apps</li> {% endcomment %}
										<li class="breadcrumb-item"><a href="{% url 'projects' %}">Tous les Projets</a></li>
										<li class="breadcrumb-item active" aria-current="page">Détails du projet</li>
									</ol>
								</div>
								<script src="https://api.sentinel-hub.com/js/sentinelhub-js-2.2.0.min.js"></script>
							</div>
							<!-- PAGE-HEADER END -->
							<!--ROW OPENED-->
							<body>
								<div class="row">
									<div class="col-md-12">
										<input id="data-id" style="display: none;" value="{{ data }}" />
										<div class="btn-list text-end mb-3">
											<a href="{% url 'index' %}" class="btn btn-primary active text-white me-2">Magon</a>
											<a href="#" class="btn btn-outline-primary me-2">Modifier</a>
											{% comment %} <a href="{% url 'project-new' %}" class="btn btn-outline-primary me-2">New</a> {% endcomment %}
										</div>
										<div id="map">
											<!-- Map coordinate  -->
											<div class="leaflet-control map-coordinate">
												<div class="coordinate"></div>
											</div>
										</div>
										<div class="menu">
											<button id="btn1" class="menu-button" onclick="btn1()">
												<img class="image_menu" src="{% static 'assets/images/icons/watering-plants.png' %}" alt="buttonpng" border="0" />
											</button>
											<button id="btn2" class="menu-button" onclick="btn2()">
												<img class="image_menu" src="{% static 'assets/images/icons/fertilizer-2.png' %}" alt="buttonpng" border="0" />
											</button>

											<button id="btn3" class="menu-button" onclick="btn3()">
												<img class="image_menu" src="{% static 'assets/images/icons/pests.png' %}" alt="buttonpng" border="0" />
											</button>
											<button id="btn4" class="menu-button" onclick="btn4()">
												<img class="image_menu" src="{% static 'assets/images/icons/peasant.png' %}" alt="buttonpng" border="0" />
											</button>
                                            <button id="btn5" class="menu-button" onclick="btn5()">
												<img class="image_menu" src="{% static 'assets/images/icons/grain-bag.png' %}" alt="buttonpng" border="0" />
											</button>
										</div>
										<div id="color-reference-table" class="referencecl hidden">
												<table id="reference-table" style="width:100%">
													<!-- Les lignes du tableau seront ajoutées par JavaScript -->
												</table>
										</div>
										<div class="irrigation" id="irrig">
											
											<div class="custom-select-wrapper">
												<div id="select-toggle" class="custom-select">
													<span>Select parcels</span>
													<div class="select-items" id="parcelle-select">
														{% for parcelle in project.parcelles %}
															<label>
																<input type="checkbox" name="parcelle" value="{{ parcelle.geozone_id }}">
																{{ parcelle.parcelle_name }}
															</label>
														{% endfor %}
													</div>
												</div>
											</div>
											<script>
												// Toggle the display of the custom select dropdown
												document.getElementById('select-toggle').addEventListener('click', function() {
													var selectItems = document.getElementById('parcelle-select');
													selectItems.style.display = selectItems.style.display === 'block' ? 'none' : 'block';
												});
											
												// Function to update map points based on selected checkboxes
												function updateMapPoints(parcelleIds) {
													// Remove all existing polylines
													map.eachLayer(function(layer) {
														if (layer instanceof L.Polyline) {
															map.removeLayer(layer);
														}
													});
											
													// Function to fetch and add points for a single parcel
													function fetchAndAddPoints(parcelleId) {
														fetch('/points/' + parcelleId)
															.then(response => response.json())
															.then(data => {
																// Convert data to an array of LatLng coordinates
																var latlngs = data.map(function(point) {
																	return [parseFloat(point.latt), parseFloat(point.long)];
																});
											
																// Draw the polyline on the map
																var polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);
											
																// Extend the map bounds to include the new polyline
																map.fitBounds(polyline.getBounds(), { animate: false });
															});
													}
											
													// Loop through all selected parcel IDs and fetch their points
													parcelleIds.forEach(parcelleId => {
														if (parcelleId) {
															fetchAndAddPoints(parcelleId);
														}
													});
												}
											
												// Listen for changes in the checkboxes
												document.getElementById('parcelle-select').addEventListener('change', function() {
													var checkboxes = document.querySelectorAll('input[name="parcelle"]:checked');
													var selectedGeozoneIds = Array.from(checkboxes).map(checkbox => checkbox.value);
											
													// Update the map with the selected parcels
													updateMapPoints(selectedGeozoneIds);
												});
											
												// Close the dropdown if the user clicks outside of it
												window.addEventListener('click', function(event) {
													if (!event.target.matches('#select-toggle') && !event.target.closest('#parcelle-select')) {
														var selectItems = document.getElementById('parcelle-select');
														if (selectItems.style.display === 'block') {
															selectItems.style.display = 'none';
														}
													}
												});
											</script>
											<select id="filtre-select" onchange="updateColorTable()">
												<option>Filtre</option>
												{% for category, filters in filter_categories.items %}
													<optgroup label="{{ category|title }}">
														{% for filter in filters %}
															<option value="{{ filter.abreviation }}"
																	data-toggle="tooltip"
																	data-placement="top"
																	title="{{ filter.details }}">
																{{ filter.abreviation }}
															</option>
														{% endfor %}
													</optgroup>
												{% endfor %}
											</select>
											<script>
												$(document).ready(function(){
													$('[data-toggle="tooltip"]').tooltip();
												});
											</script> 	
											<input type="date" id="datepicker" placeholder="Select date" onchange="getRasterImage()">
											
										</div>
										<script>
											const anomalyIconUrl = "{% static 'assets/images/icons/detection.png' %}";
										</script>
																		
										 <!-- leaflet js  -->
									<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
									<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
									<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
									<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
									<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>									
									<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
									{% comment %} <script src="{% static './lib/leaflet-measure.js' %}"></script> {% endcomment %}
									<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>	
									<!-- leaflet draw plugin  -->
									<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
									<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>	
									<script src="{% static 'assets/js/project-details-map.js' %}" type="text/javascript"></script>
									<span id="project-name-id" style="display:none;"></span>	
													{% comment %} <div class="col-xl-auto col-md0-1">
														<div class="btn-list">
															<a href="javascript:void(0)" class="btn btn-primary-light text-center me-2" data-bs-placement="top" data-bs-toggle="tooltip" data-bs-original-title="Alarm"><i class="fe fe-clock"></i></a>
															<a href="javascript:void(0)" class="btn btn-primary-light text-center me-2" data-bs-placement="top" data-bs-toggle="tooltip" data-bs-original-title="Comment"><i class="fe fe-message-circle"></i></a>
															<a href="javascript:void(0)" class="btn btn-primary-light text-center me-2" data-bs-placement="top" data-bs-toggle="tooltip" data-bs-original-title="Upload Files"><i class="fe fe-upload"></i></a>
															<a href="javascript:void(0)" class="btn btn-primary-light text-center me-2" data-bs-placement="top" data-bs-toggle="tooltip" data-bs-original-title="Mail"><i class="fe fe-mail"></i></a>
														</div>
													</div> {% endcomment %}
									</div>	
									<div class="col-md-12">
										<div class="tab-content">
											<div class="tab-pane active" id="tab_1">
												<!-- ROW -->
												<div class="row">
													<div class="col-xl-12 col-lg-24" style="top: 20px;">
														<div class="card">
															<div class="card-header border-bottom d-block">
																<div class="row align-items-center">
																	<div class="col">
																		<h4 id="project-name-id-2" class="mb-1"></h4>
																		<div class="d-sm-flex d-block">
																			<div id="project-date-id" class="text-muted pe-2 project-date"></div>
																		</div>
																	</div>
																	{% comment %} <div class="col-auto">
																		<div class="d-flex align-items-center">
																			<div class="ms-3">
																				<a href="#" class="text-muted" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fe fe-more-vertical"></i></a>
																				<div class="dropdown-menu dropdown-menu-start">
																					<a class="dropdown-item" href="#"><i class="fe fe-edit me-2"></i> Modifier</a>
																					<a class="dropdown-item" href="#"><i class="fe fe-trash me-2"></i> Supprimer</a>
																				</div>
																			</div>
																		</div>
																	</div> {% endcomment %}
																</div>
															</div>
															{% comment %} <div class="card-body">
																<h5 class="mb-2">Project Details:</h5>
																<p class="line-height-5 m-0 text-muted">Eirmod voluptua no at at sit dolor voluptua nonumy. Et Et ut rebum est aliquyam dolor clita. Amet ipsum et dolor ipsum. Dolor clita rebum. aliquyam gubergren est gubergren. Sit stet sit ipsum est sea clita sed gubergren. Sea duo dolores elitr et ipsum sadipscing et dolores, sanctus et vero sea diam duo no, amet.</p>
																<ul class="mt-2">
																	<li class="text-muted">
																		<svg xmlns="http://www.w3.org/2000/svg" class="w-inner-icn list-indicator" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M14.8534546,11.6465454l-4.5-4.5c-0.1937256-0.1871948-0.5009155-0.1871948-0.6947021,0C9.460144,7.3383789,9.4546509,7.6549072,9.6464844,7.8535156L13.7930298,12l-4.1465454,4.1464844c-0.09375,0.09375-0.1464233,0.2208862-0.1464233,0.3534546C9.5,16.776062,9.723877,16.999939,10,17c0.1326294,0.0001221,0.2598267-0.0525513,0.3534546-0.1464844l4.5-4.5c0.000061-0.000061,0.0001221-0.000061,0.0001831-0.0001221C15.0487671,12.1581421,15.0487061,11.8416748,14.8534546,11.6465454z"/></svg>
																		Ea eos nonumy diam duo elitr. Takimata vero sit eirmod sit. Sea diam vero ipsum.
																	</li>
																	<li class="text-muted mt-1">
																		<svg xmlns="http://www.w3.org/2000/svg" class="w-inner-icn list-indicator" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M14.8534546,11.6465454l-4.5-4.5c-0.1937256-0.1871948-0.5009155-0.1871948-0.6947021,0C9.460144,7.3383789,9.4546509,7.6549072,9.6464844,7.8535156L13.7930298,12l-4.1465454,4.1464844c-0.09375,0.09375-0.1464233,0.2208862-0.1464233,0.3534546C9.5,16.776062,9.723877,16.999939,10,17c0.1326294,0.0001221,0.2598267-0.0525513,0.3534546-0.1464844l4.5-4.5c0.000061-0.000061,0.0001221-0.000061,0.0001831-0.0001221C15.0487671,12.1581421,15.0487061,11.8416748,14.8534546,11.6465454z"/></svg>
																		Accusam ipsum labore dolor amet ea, accusam dolore dolor dolore.
																	</li>
																	<li class="text-muted mt-1">
																		<svg xmlns="http://www.w3.org/2000/svg" class="w-inner-icn list-indicator" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M14.8534546,11.6465454l-4.5-4.5c-0.1937256-0.1871948-0.5009155-0.1871948-0.6947021,0C9.460144,7.3383789,9.4546509,7.6549072,9.6464844,7.8535156L13.7930298,12l-4.1465454,4.1464844c-0.09375,0.09375-0.1464233,0.2208862-0.1464233,0.3534546C9.5,16.776062,9.723877,16.999939,10,17c0.1326294,0.0001221,0.2598267-0.0525513,0.3534546-0.1464844l4.5-4.5c0.000061-0.000061,0.0001221-0.000061,0.0001831-0.0001221C15.0487671,12.1581421,15.0487061,11.8416748,14.8534546,11.6465454z"/></svg>
																		Nonumy gubergren gubergren lorem dolore nonumy lorem kasd, labore sit eirmod sed.
																	</li>
																	<li class="text-muted mt-1">
																		<svg xmlns="http://www.w3.org/2000/svg" class="w-inner-icn list-indicator" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M14.8534546,11.6465454l-4.5-4.5c-0.1937256-0.1871948-0.5009155-0.1871948-0.6947021,0C9.460144,7.3383789,9.4546509,7.6549072,9.6464844,7.8535156L13.7930298,12l-4.1465454,4.1464844c-0.09375,0.09375-0.1464233,0.2208862-0.1464233,0.3534546C9.5,16.776062,9.723877,16.999939,10,17c0.1326294,0.0001221,0.2598267-0.0525513,0.3534546-0.1464844l4.5-4.5c0.000061-0.000061,0.0001221-0.000061,0.0001831-0.0001221C15.0487671,12.1581421,15.0487061,11.8416748,14.8534546,11.6465454z"/></svg>
																		Ipsum elitr no sed takimata dolore.
																	</li>
																</ul>
															</div> {% endcomment %}
														</div>
														<div class="card">
															<div class="card-body">
																<div class="row prjct-details">
																	<div class="col-xl-3 col-lg-12">
																		<div class="text-center border py-5 br-5 details">
																			<div>
																				<span class="m-0 text-muted"><i class="fe fe-calendar"></i> Date de début :</span>
																			</div>
																			<h5 id="project-date-id-2" class="mt-3 text-teritary"></h5>
																		</div>
																	</div>
																	<div class="col-xl-3 col-lg-12">
																		<div class="d-f-ai-c-jc-c flex-column border py-5 br-5 details">
																			<div>
																				<span class="m-0 text-muted"><i class="fe fe-user"></i> Attribué à :</span>
																			</div>
																				{% comment %} <img class="avatar-sm rounded-circle me-3 my-auto" src="{% static 'assets/images/faces/11.jpg' %}" alt="Image description"> {% endcomment %}
																				<h5 id="client-id" class="mt-3 text-teritary"></h5>
																		</div>
																	</div>
																	<div class="col-xl-3 col-lg-12">
																		<div class="d-f-ai-c-jc-c flex-column border py-5 br-5 details">
																			<div>
																				<span class="m-0 text-muted">
																					<img src="{% static 'assets/images/icons/commodity.png' %}" alt="Catégorie de projet" style="width: 24px; height: 24px;">
																					Culture :
																				</span>
																			</div>
																				{% comment %} <img class="avatar-sm rounded-circle me-3 my-auto" src="{% static 'assets/images/faces/11.jpg' %}" alt="Image description"> {% endcomment %}
																				<h5 id="project-category-id" class="mt-3 text-teritary"></h5>
																		</div>
																	</div>
																	<div class="col-xl-3 col-lg-12">
																		<div class="d-f-ai-c-jc-c flex-column border py-5 br-5 details">
																			<div>
																				<span class="m-0 text-muted">
																					<img src="{% static 'assets/images/icons/chip.png' %}" alt="Catégorie de projet" style="width: 24px; height: 24px;"> 
																					Type de culture :
																				</span>
																			</div>
																				{% comment %} <img class="avatar-sm rounded-circle me-3 my-auto" src="{% static 'assets/images/faces/11.jpg' %}" alt="Image description"> {% endcomment %}
																				<h5 id="department-id" class="mt-3 text-teritary"></h5>
																		</div>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div><!--ROW CLOSED-->	
												<span id="client-id" style="display:none;"></span>
											</div>	
										</div>
									</div>
								</div>							
							<!--ROW CLOSED-->
		</body>
		{% endblock %}
    {% block scripts %}
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
		
	    <script src="https://assets.sentinel-hub.com/-components/api3/sh-api.js" onload="init()" async defer></script>	    
		<!-- INTERNAL SELECT2 JS -->
		<script src="{% static 'assets/plugins/select2/select2.full.min.js'%}"></script>
		<!-- FILE UPLOAD JS -->
        <script src="{% static 'assets/plugins/fileuploads/js/fileupload.js'%}"></script>
        <script src="{% static 'assets/plugins/fileuploads/js/file-upload.js'%}"></script>
		<!-- bootstrap-datepicker js -->
		<script src="{% static 'assets/plugins/bootstrap-datepicker/js/datepicker.js'%}"></script>
		<!-- INTERNAL Data tables js-->
		<script src="{% static 'assets/plugins/datatable/js/jquery.dataTables.min.js'%}"></script>
		<script src="{% static 'assets/plugins/datatable/js/dataTables.bootstrap5.js'%}"></script>
		<script src="{% static 'assets/plugins/datatable/dataTables.responsive.min.js'%}"></script>
		<!-- PROJECT-DETAILS JS-->
		<script src="{% static 'assets/js/project-details.js'%}"></script>
		<script src="{% static 'assets/js/indicesvegitatiionscolors.js'%}"></script>
        <!-- COLOR THEME JS -->
        <script src="{% static 'assets/js/themeColors.js'%}"></script>
    {% endblock %}