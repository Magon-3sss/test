{% load static %}
<!doctype html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Magon â€“ Smart Agriculture Solution">
    <meta name="author" content="Spruko Technologies Private Limited">
    <meta name="keywords" content="admin,admin dashboard,admin panel,admin template,bootstrap,clean,dashboard,flat,jquery,modern,responsive,premium admin templates,responsive admin,ui,ui kit.">

    <title>Magon</title>
    {% include 'components/layouts/styles.html' %}
    {% block styles %}{% endblock %}
</head>

<body class="ltr app sidebar-mini light-mode">
    {% include 'components/layouts/switcher.html' %}
    
    <div id="global-loader">
        <img src="{% static 'assets/images/loader.svg'%}" class="loader-img" alt="Loader">
    </div>
    
    <div style="display: flex; flex-direction: column; min-height: 100vh;">
        <div style="flex: 1 1 1;">
            {% include 'components/layouts/app-header.html' %}
            {% include 'components/layouts/app-sidebar.html' %}

            <div class="app-content main-content mt-0">
                <div class="side-app">
                    <div class="main-container container-fluid">
                        <h1>Gestion des Utilisateurs</h1>

                        <!-- Ajouter un groupe -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h2>Ajouter un Nouveau Groupe</h2>
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    {% csrf_token %}
                                    {{ group_creation_form.as_p }}
                                    <button type="submit" name="add_group" class="btn btn-primary">Ajouter Groupe</button>
                                </form>
                            </div>
                        </div>

                        <!-- Liste des groupes -->
                        {% comment %} <div class="card mb-4">
                            <div class="card-header">
                                <h2>Groupes Existants</h2>
                            </div>
                            <div class="card-body">
                                <ul class="list-group">
                                    {% for group in groups %}
                                        <li class="list-group-item">{{ group.name }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div> {% endcomment %}
                        
                        <!-- Ajouter un utilisateur -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h2>Ajouter un Utilisateur</h2>
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    {% csrf_token %}
                                    {{ user_form.as_p }}
                                    <button type="submit" name="add_user" class="btn btn-success">Ajouter Utilisateur</button>
                                </form>
                            </div>
                        </div>

                        <!-- Liste des utilisateurs avec formulaire de modification de groupe et suppression -->
                        <div class="card">
                            <div class="card-header">
                                <h2>Utilisateurs Existants</h2>
                            </div>
                            <div class="card-body">
                                <ul class="list-group">
                                    {% for user in users %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                {{ user.username }} - {{ user.email }} - Groupes: {% for group in user.groups.all %}{{ group.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                            </div>
                                            
                                            <!-- Formulaire de modification de groupe et suppression -->
                                            <div class="d-flex">
                                                <!-- Formulaire de modification de groupe -->
                                                <form method="POST" class="form-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="username_to_update" value="{{ user.username }}">
                                                    <select name="group" class="form-control form-control-sm">
                                                        {% for group in group_form.fields.groups.queryset %}
                                                            <option value="{{ group.id }}" {% if group in user.groups.all %}selected{% endif %}>{{ group.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <button type="submit" name="change_group" class="btn btn-warning btn-sm"><svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title></title> <g id="Complete"> <g id="edit"> <g> <path d="M20,16v4a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V6A2,2,0,0,1,4,4H8" fill="none" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path> <polygon fill="none" points="12.5 15.8 22 6.2 17.8 2 8.3 11.5 8 16 12.5 15.8" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polygon> </g> </g> </g> </g></svg></button>
                                                </form>

                                                <!-- Formulaire de suppression d'utilisateur -->
                                                <form method="POST" class="ml-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="username_to_delete" value="{{ user.username }}">
                                                    <button type="submit" name="delete_user" class="btn btn-danger btn-sm"><svg height="24" width="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M10 11V17" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M14 11V17" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 7H20" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M6 7H12H18V18C18 19.6569 16.6569 21 15 21H9C7.34315 21 6 19.6569 6 18V7Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg></button>
                                                </form>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-info mt-3">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% block modal %}{% endblock %}
        {% include 'components/layouts/modal.html' %}
        {% include 'components/layouts/footer.html' %}
    </div>

    {% include 'components/layouts/scripts.html' %}
    {% block scripts %}{% endblock %}
</body>
</html>